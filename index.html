
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <title>EMG éŸ³æ•ˆæ•´åˆç©©å®šç‰ˆ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    canvas { max-width: 100%; height: 250px; }
    .btn-group { margin: 10px 0; }
    button {
      font-size: 1.1em; padding: 8px 16px; margin-right: 10px;
      border: none; border-radius: 5px; cursor: pointer;
    }
    select, input[type="number"] {
      font-size: 1em; margin-left: 10px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h2>EMG åŸå§‹æ³¢å½¢åœ–</h2>
<div class="btn-group">
  <button id="toggleMp3Btn" onclick="toggleMp3()" style="background-color:#ff6600; color:white;">åˆ‡æ›MP3éŸ³æ•ˆï¼ˆç›®å‰ï¼šé—œï¼‰</button>
  <label>MP3é–€æª»å€¼ï¼š<input id="mp3Threshold" type="number" value="350" style="width: 80px;"/></label>
</div>
<div class="btn-group">
  <button onclick="connect()" style="background-color:#28a745; color:white;">é€£æ¥è—ç‰™</button>
  <button id="pauseBtn" onclick="togglePause()" style="background-color:#007BFF; color:white;">æš«åœ</button>
</div>
<p id="value">åŸå§‹æ•¸å€¼ï¼š--</p>
<canvas id="emgChart"></canvas>
<h2>EMG æ ¡æ­£æ³¢å½¢åœ–
  <button onclick="performCalibration()" style="background-color:#ffc107; color:black; font-size: 0.9em;">ğŸ“ æ ¡æ­£</button>
</h2>
<canvas id="zoomChart"></canvas>
<p id="adjusted">æ ¡æ­£å¾Œæ•¸å€¼ï¼š--</p>
<p id="mvc">å³æ™‚å¼·åº¦ï¼š-- %</p>
<div class="btn-group">
  <label>æ ¡æ­£æ•¸å€¼å€ç‡ï¼š
    <select id="amplifyRate">
      <option value="1">100%</option>
      <option value="1.2">120%</option>
      <option value="1.4">140%</option>
      <option value="1.6">160%</option>
      <option value="1.8">180%</option>
      <option value="2">200%</option>
    </select>
  </label>
</div>
<div class="btn-group">
  <button onclick="setMode('raw')" style="background-color:#17a2b8; color:white;">åŸå§‹</button>
  <button onclick="setMode('mean')" style="background-color:#17a2b8; color:white;">å¹³å‡</button>
  <button onclick="setMode('max')" style="background-color:#17a2b8; color:white;">æœ€å¤§å€¼</button>
  <button onclick="setMode('rms')" style="background-color:#17a2b8; color:white;">RMS</button>
  <button onclick="resetMax()" style="background-color:#6c757d; color:white;">é‡è¨­æœ€å¤§å€¼</button>
</div>

<script>
let characteristic = null;
let isPaused = false;
let isCalibrated = false;
let calibrationBaseline = 0;
let maxAdjusted = 1;
let mode = 'raw';
const AVG_WINDOW = 10;
let emgBuffer = Array(AVG_WINDOW).fill(0);
const rawData = Array(100).fill(0);
const zoomData = Array(100).fill(0);
let lastEMG = 0;

// éŸ³æ•ˆè¨­å®š
let mp3Enabled = false;
let audioContext = null;
let mp3Buffer = null;

// åœ–è¡¨åˆå§‹åŒ–
const emgChart = new Chart(document.getElementById('emgChart'), {
  type: 'line',
  data: { labels: Array(100).fill(''), datasets: [{ label: 'åŸå§‹ EMG', data: rawData, borderColor: 'blue' }] },
  options: { animation: false, responsive: true, scales: { y: { suggestedMin: 0, suggestedMax: 1023 } } }
});
const zoomChart = new Chart(document.getElementById('zoomChart'), {
  type: 'line',
  data: { labels: Array(100).fill(''), datasets: [{ label: 'æ ¡æ­£å¾Œ EMG', data: zoomData, borderColor: 'green' }] },
  options: { animation: false, responsive: true, scales: { y: { min: -100, max: 200 } } }
});

// è™•ç†æ¨¡å¼
function getProcessedEMG(val) {
  emgBuffer.push(val); emgBuffer.shift();
  if (mode === 'raw') return val;
  if (mode === 'mean') return Math.floor(emgBuffer.reduce((a, b) => a + b, 0) / AVG_WINDOW);
  if (mode === 'max') return Math.max(...emgBuffer);
  if (mode === 'rms') return Math.floor(Math.sqrt(emgBuffer.reduce((a, b) => a + b * b, 0) / AVG_WINDOW));
  return val;
}

function setMode(m) {
  mode = m;
  alert('æ¨¡å¼åˆ‡æ›ç‚ºï¼š' + m);
}
function resetMax() {
  maxAdjusted = 1;
}

// éŸ³æ•ˆåˆ‡æ›èˆ‡åˆå§‹åŒ–
function toggleMp3() {
  mp3Enabled = !mp3Enabled;
  const btn = document.getElementById("toggleMp3Btn");
  if (btn) btn.innerText = "åˆ‡æ›MP3éŸ³æ•ˆï¼ˆç›®å‰ï¼š" + (mp3Enabled ? "é–‹" : "é—œ") + "ï¼‰";

  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioContext.state === 'suspended') {
    audioContext.resume();
  }

  fetch("https://u9010269.github.io/emg-wave-app/350.mp3")
    .then(resp => resp.arrayBuffer())
    .then(data => audioContext.decodeAudioData(data))
    .then(buffer => {
      mp3Buffer = buffer;
      const source = audioContext.createBufferSource();
      source.buffer = mp3Buffer;
      source.connect(audioContext.destination);
      source.start();
    })
    .catch(err => alert("éŸ³æ•ˆåˆå§‹åŒ–å¤±æ•—ï¼Œè«‹å†æ¬¡é»æ“Š"));
}

// è®€å– EMG ä¸¦æ›´æ–°åœ–è¡¨èˆ‡éŸ³æ•ˆ
async function readEMG() {
  if (!characteristic || isPaused) return;
  const value = await characteristic.readValue();
  const emg = parseInt(new TextDecoder().decode(value).trim());
  if (isNaN(emg)) return;

  rawData.push(emg); rawData.shift(); emgChart.update();
  let processed = getProcessedEMG(emg);
  let adjusted = isCalibrated ? Math.max(0, processed - calibrationBaseline) : 0;
  const amplify = parseFloat(document.getElementById('amplifyRate').value);
  const amplified = Math.floor(adjusted * amplify);
  zoomData.push(amplified); zoomData.shift(); zoomChart.update();
  if (amplified > maxAdjusted) maxAdjusted = amplified;
  const percent = Math.round((amplified / maxAdjusted) * 100);

  document.getElementById('value').innerText = 'åŸå§‹æ•¸å€¼ï¼š' + emg;
  document.getElementById('adjusted').innerText = 'æ ¡æ­£å¾Œæ•¸å€¼ï¼š' + amplified;
  document.getElementById('mvc').innerText = 'å³æ™‚å¼·åº¦ï¼š' + percent + ' %';

  const threshold = parseInt(document.getElementById('mp3Threshold').value);
  if (mp3Enabled && mp3Buffer && lastEMG <= threshold && emg > threshold) {
    const source = audioContext.createBufferSource();
    source.buffer = mp3Buffer;
    source.connect(audioContext.destination);
    source.start();
  }
  lastEMG = emg;
}

// é€£æ¥è—ç‰™èˆ‡å•Ÿå‹•è®€å–
async function connect() {
  const device = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: 'MLT' }], optionalServices: ['ffe0'] });
  const server = await device.gatt.connect();
  const service = await server.getPrimaryService('ffe0');
  characteristic = await service.getCharacteristic('ffe1');
  setInterval(readEMG, 30);
}

// æš«åœæ’­æ”¾
function togglePause() {
  isPaused = !isPaused;
  document.getElementById("pauseBtn").innerText = isPaused ? "æ¢å¾©" : "æš«åœ";
}

// æ ¡æ­£åŸºæº–
async function performCalibration() {
  let sum = 0, count = 0;
  alert("è«‹ä¿æŒæ”¾é¬†ï¼Œé–‹å§‹æ ¡æ­£...");
  const interval = setInterval(async () => {
    const value = await characteristic.readValue();
    const emg = parseInt(new TextDecoder().decode(value).trim());
    if (!isNaN(emg)) {
      sum += emg; count++;
      if (count >= 100) {
        calibrationBaseline = Math.floor(sum / count);
        isCalibrated = true;
        clearInterval(interval);
        alert("æ ¡æ­£å®Œæˆï¼ŒåŸºæº–å€¼ï¼š" + calibrationBaseline);
      }
    }
  }, 100);
}
</script>
</body>
</html>
