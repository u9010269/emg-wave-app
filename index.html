<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EMG 波形圖 (Polling版)</title>
<style>
    body {
        background-color: black;
        color: #0f0;
        text-align: center;
        font-family: Arial, sans-serif;
    }
    canvas {
        background-color: #111;
        display: block;
        margin: 0 auto;
    }
    button {
        font-size: 20px;
        padding: 10px 20px;
        margin: 20px;
    }
</style>
</head>
<body>

<h1>EMG 即時波形圖 (Polling版)</h1>
<button onclick="connectBluetooth()">連接 EMG 裝置</button>
<canvas id="waveform" width="400" height="200"></canvas>
<p id="emgValue">EMG 數值: -</p>

<script>
let canvas = document.getElementById('waveform');
let ctx = canvas.getContext('2d');
let values = new Array(canvas.width).fill(100);
let characteristic = null;

function draw() {
    ctx.fillStyle = '#111';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.strokeStyle = '#0f0';
    ctx.beginPath();
    ctx.moveTo(0, canvas.height - values[0]);

    for (let x = 1; x < values.length; x++) {
        ctx.lineTo(x, canvas.height - values[x]);
    }

    ctx.stroke();
}

function addValue(val) {
    values.push(val);
    values.shift();
    draw();
}

async function connectBluetooth() {
    try {
        const device = await navigator.bluetooth.requestDevice({
            filters: [{ services: ["ffe0"] }]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService("ffe0");
        characteristic = await service.getCharacteristic("ffe1");

        alert("已連線，開始讀取數據");
        startPolling();

    } catch (error) {
        alert("連線失敗: " + error);
    }
}

function startPolling() {
    setInterval(async () => {
        if (characteristic) {
            try {
                const value = await characteristic.readValue();
                let emg = value.getUint8(0);
                document.getElementById("emgValue").innerText = "EMG 數值: " + emg;

                let mapped = Math.min(200, Math.max(0, emg));
                addValue(mapped);
            } catch (e) {
                console.log("讀取失敗", e);
            }
        }
    }, 100); // 每100ms讀取一次
}

// 初始化畫面
setInterval(() => addValue(values[values.length - 1]), 50);

</script>

</body>
</html>
