<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>EMG 回復穩定版（含音效與UI）</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { font-family: sans-serif; padding: 20px; }
    canvas { max-width: 100%; height: 250px; }
    .btn-group { margin-top: 10px; margin-bottom: 10px; }
    button {
      font-size: 1.1em; padding: 8px 16px; margin-right: 10px; margin-bottom: 6px;
      border: none; border-radius: 5px; cursor: pointer;
    }
    select, input[type="number"] {
      font-size: 1em; margin-left: 10px;
    }
</style>
</head>
<body>
<h2>EMG 原始波形圖（地震圖）</h2>
<div class="btn-group">
    <button onclick="connect()" style="background-color:#28a745; color:white;">連接藍牙</button>
    <button id="pauseBtn" onclick="togglePause()" style="background-color:#007BFF; color:white;">暫停</button>

    <!-- 新增 MP3 播放開關 -->
    <button onclick="toggleMP3()" style="background-color:#dc3545; color:white;">MP3 播放（目前：關）</button>
    
    <!-- 新增閥值輸入框 -->
    <label>MP3 播放閥值：
        <input type="number" id="mp3Threshold" value="350" style="width: 80px;">
    </label>
</div>

<p id="value">原始數值：--</p>
<canvas id="emgChart"></canvas>

<h2 id="zoomTitle">EMG 校正波形圖（處理模式）
    <button onclick="performCalibration()" style="background-color:#ffc107; color:black; font-size: 0.9em; margin-left: 10px;">📍 校正</button>
</h2>
<canvas id="zoomChart"></canvas>
<p id="adjusted">校正後數值：--</p>
<p id="mvc">即時強度：-- %</p>

<script>
    let characteristic, pauseBtn = null;
    let isPaused = false, soundEnabled = true, isMP3Enabled = false;
    let audioCtx = null, oscillator = null, gainNode = null;
    let lastMP3Played = false; // 確保 MP3 不會連續播放
    const rawData = Array(100).fill(0);

    const emgChart = new Chart(document.getElementById('emgChart'), {
        type: 'line',
        data: { labels: Array(100).fill(''), datasets: [{ label: '原始 EMG', data: rawData, borderColor: 'blue', borderWidth: 1 }] },
        options: { animation: false, responsive: true, scales: { y: { suggestedMin: 0, suggestedMax: 1023 } } }
    });

    async function connect() {
        const device = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: 'MLT' }], optionalServices: ['ffe0'] });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('ffe0');
        characteristic = await service.getCharacteristic('ffe1');
        pauseBtn = document.getElementById('pauseBtn');
        setInterval(readEMG, 30);
    }

    function togglePause() {
        isPaused = !isPaused;
        pauseBtn.innerText = isPaused ? "恢復" : "暫停";
    }

    function toggleMP3() {
        isMP3Enabled = !isMP3Enabled;
        document.querySelector("button[onclick='toggleMP3()']").innerText = "MP3 播放（目前：" + (isMP3Enabled ? "開" : "關") + "）";
    }

    async function readEMG() {
        if (!characteristic || isPaused) return;
        const value = await characteristic.readValue();
        const emg = parseInt(new TextDecoder().decode(value).trim());
        if (isNaN(emg)) return;

        rawData.push(emg);
        rawData.shift();
        emgChart.update();
        document.getElementById('value').innerText = '原始數值：' + emg;

        const mp3Threshold = parseInt(document.getElementById('mp3Threshold').value);

        // MP3 播放邏輯：EMG 超過閥值且 MP3 開啟時播放一次
        if (isMP3Enabled) {
            if (emg > mp3Threshold && !lastMP3Played) {
                playMP3();
                lastMP3Played = true;
            } else if (emg <= mp3Threshold) {
                lastMP3Played = false; // 允許再次播放
            }
        }
    }

    function playMP3() {
        const audio = new Audio('https://github.com/你的MP3檔案位置.mp3'); // 請替換成正確的 MP3 連結
        audio.play();
    }
</script>
</body>
</html>
