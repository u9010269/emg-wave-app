<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>EMG Debug 波形顯示</title>
  <style>
    canvas { border: 1px solid #ccc; width: 100%; height: 200px; }
    body { font-family: sans-serif; padding: 1em; }
    #log { white-space: pre-line; background: #f9f9f9; padding: 1em; height: 100px; overflow-y: scroll; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>EMG Web Bluetooth 波形 (Debug版)</h2>
  <button id="connect">連接藍牙</button>
  <p>即時數值：<span id="value">--</span></p>
  <canvas id="canvas" width="600" height="200"></canvas>
  <h3>資料記錄 (log)</h3>
  <div id="log"></div>

  <script>
    let characteristic;
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let data = Array(600).fill(100);
    let log = document.getElementById('log');

    function drawGraph() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      ctx.moveTo(0, canvas.height - data[0]);
      for (let x = 1; x < data.length; x++) {
        ctx.lineTo(x, canvas.height - data[x]);
      }
      ctx.strokeStyle = '#0074D9';
      ctx.stroke();
    }

    function logText(text) {
      log.textContent += text + "\n";
      log.scrollTop = log.scrollHeight;
    }

    function processData(value) {
      const text = new TextDecoder().decode(value);
      logText("收到: " + text);

      const match = text.match(/EMG:(\d+)/);
      if (match) {
        const raw = parseInt(match[1]);
        document.getElementById('value').textContent = raw;
        const y = Math.max(0, Math.min(200, raw - 200));
        data.push(y);
        if (data.length > 600) data.shift();
        drawGraph();
      }
    }

    document.getElementById('connect').addEventListener('click', async () => {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'MLT' }],
          optionalServices: ['ffe0']
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('ffe0');
        characteristic = await service.getCharacteristic('ffe1');

        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', (event) => {
          processData(event.target.value);
        });
        alert('藍牙連線成功！開始接收資料...');
      } catch (e) {
        alert('連線錯誤：' + e);
        logText('錯誤：' + e);
      }
    });
  </script>
</body>
</html>
