<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>EMG å›å¾©ç©©å®šç‰ˆï¼ˆå«éŸ³æ•ˆèˆ‡UIï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { font-family: sans-serif; padding: 20px; }
    canvas { max-width: 100%; height: 250px; }
    .btn-group { margin-top: 10px; margin-bottom: 10px; }
    button {
      font-size: 1.1em; padding: 8px 16px; margin-right: 10px; margin-bottom: 6px;
      border: none; border-radius: 5px; cursor: pointer;
    }
    select, input[type="number"] {
      font-size: 1em; margin-left: 10px;
    }
</style>
</head>
<body>
<h2>EMG åŸå§‹æ³¢å½¢åœ–ï¼ˆåœ°éœ‡åœ–ï¼‰</h2>
<div class="btn-group">
    <button onclick="connect()" style="background-color:#28a745; color:white;">é€£æ¥è—ç‰™</button>
    <button id="pauseBtn" onclick="togglePause()" style="background-color:#007BFF; color:white;">æš«åœ</button>

    <!-- MP3 æ’­æ”¾é–‹é—œ -->
    <button id="toggleMp3Btn" onclick="toggleMp3()" style="background-color:#dc3545; color:white;">MP3 æ’­æ”¾ï¼ˆç›®å‰ï¼šé—œï¼‰</button>

    <!-- é–¥å€¼è¼¸å…¥æ¡† -->
    <label>MP3 æ’­æ”¾é–¥å€¼ï¼š
        <input type="number" id="mp3Threshold" value="350" style="width: 80px;">
    </label>
</div>

<p id="value">åŸå§‹æ•¸å€¼ï¼š--</p>
<canvas id="emgChart"></canvas>

<h2 id="zoomTitle">EMG æ ¡æ­£æ³¢å½¢åœ–ï¼ˆè™•ç†æ¨¡å¼ï¼‰
    <button onclick="performCalibration()" style="background-color:#ffc107; color:black; font-size: 0.9em; margin-left: 10px;">ğŸ“ æ ¡æ­£</button>
</h2>
<canvas id="zoomChart"></canvas>
<p id="adjusted">æ ¡æ­£å¾Œæ•¸å€¼ï¼š--</p>
<p id="mvc">å³æ™‚å¼·åº¦ï¼š-- %</p>

<audio id="mp3Player" preload="auto" src="https://u9010269.github.io/emg-wave-app/350.mp3"></audio>

<script>
    let characteristic, pauseBtn = null;
    let isPaused = false, soundEnabled = true, isMP3Enabled = false;
    let lastMP3Time = 0; // è¨˜éŒ„ä¸Šæ¬¡æ’­æ”¾æ™‚é–“
    const MP3_PLAY_INTERVAL = 2000; // æ’­æ”¾é–“éš” 2 ç§’ï¼ˆå¯èª¿æ•´ï¼‰
    const rawData = Array(100).fill(0);

    const emgChart = new Chart(document.getElementById('emgChart'), {
        type: 'line',
        data: { labels: Array(100).fill(''), datasets: [{ label: 'åŸå§‹ EMG', data: rawData, borderColor: 'blue', borderWidth: 1 }] },
        options: { animation: false, responsive: true, scales: { y: { suggestedMin: 0, suggestedMax: 1023 } } }
    });

    async function connect() {
        const device = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: 'MLT' }], optionalServices: ['ffe0'] });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('ffe0');
        characteristic = await service.getCharacteristic('ffe1');
        pauseBtn = document.getElementById('pauseBtn');
        setInterval(readEMG, 30);
    }

    function togglePause() {
        isPaused = !isPaused;
        pauseBtn.innerText = isPaused ? "æ¢å¾©" : "æš«åœ";
    }

    function toggleMp3() {
        isMP3Enabled = !isMP3Enabled;
        document.getElementById("toggleMp3Btn").innerText = "MP3 æ’­æ”¾ï¼ˆç›®å‰ï¼š" + (isMP3Enabled ? "é–‹" : "é—œ") + "ï¼‰";
    }

    async function readEMG() {
        if (!characteristic || isPaused) return;
        const value = await characteristic.readValue();
        const emg = parseInt(new TextDecoder().decode(value).trim());
        if (isNaN(emg)) return;

        rawData.push(emg);
        rawData.shift();
        emgChart.update();
        document.getElementById('value').innerText = 'åŸå§‹æ•¸å€¼ï¼š' + emg;

        const mp3Threshold = parseInt(document.getElementById("mp3Threshold").value);

        // MP3 æ’­æ”¾é‚è¼¯ï¼šç•¶ EMG è¶…éé–¥å€¼æ™‚ï¼Œé–“éš”æ’­æ”¾ MP3
        if (isMP3Enabled && emg > mp3Threshold) {
            playMP3();
        }
    }

    function playMP3() {
        const now = Date.now();
        if (now - lastMP3Time >= MP3_PLAY_INTERVAL) {
            const audio = document.getElementById("mp3Player");
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(err => console.warn("MP3 æ’­æ”¾å¤±æ•—:", err));
                lastMP3Time = now;
            }
        }
    }
</script>
</body>
</html>


