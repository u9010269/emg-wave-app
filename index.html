<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>EMG Web Bluetooth 波形 (Debug版)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    canvas { border: 1px solid #ccc; display: block; margin-top: 10px; }
    #log, #data { width: 100%; height: 120px; white-space: pre-wrap; background: #f8f8f8; border: 1px solid #ccc; margin-top: 5px; padding: 5px; overflow-y: scroll; }
  </style>
</head>
<body>
  <h2>EMG Web Bluetooth 波形 (Debug版)</h2>
  <button id="connectBtn">連接藍牙</button>
  <p>即時數值：<span id="value">--</span></p>
  <canvas id="wave" width="600" height="150"></canvas>
  <div>
    <strong>資料記錄 (log)</strong>
    <div id="log"></div>
  </div>

<script>
let chart = document.getElementById('wave').getContext('2d');
let values = Array(100).fill(0);
let logEl = document.getElementById('log');
let valueEl = document.getElementById('value');

function drawGraph() {
  const W = 600, H = 150;
  let ctx = chart;
  ctx.clearRect(0, 0, W, H);
  ctx.beginPath();
  ctx.moveTo(0, H - values[0]);
  for (let i = 1; i < values.length; i++) {
    ctx.lineTo(i * (W / values.length), H - values[i]);
  }
  ctx.strokeStyle = '#007acc';
  ctx.stroke();
}

async function connectBLE() {
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: 'MLT' }],
      optionalServices: ['ffe0']
    });
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService('ffe0');
    const characteristic = await service.getCharacteristic('ffe1');

    // 啟用 Notify（主動寫入 0x01 00 到 CCCD）
    try {
      const descriptors = await characteristic.getDescriptors();
      for (let d of descriptors) {
        if (d.uuid === '00002902-0000-1000-8000-00805f9b34fb') {
          await d.writeValue(Uint8Array.of(0x01, 0x00));
        }
      }
    } catch(e) {
      logEl.textContent += '\nCCCD 啟用失敗: ' + e;
    }

    await characteristic.startNotifications();
    characteristic.addEventListener('characteristicvaluechanged', (e) => {
      const value = new TextDecoder().decode(e.target.value).trim();
      logEl.textContent += `\n收到: ${value}`;
      const match = value.match(/EMG:(\d+)/);
      if (match) {
        const emg = parseInt(match[1]);
        valueEl.textContent = emg;
        values.push(Math.min(150, emg - 150));
        values.shift();
        drawGraph();
      }
    });
  } catch (error) {
    alert('藍牙連線失敗：' + error);
  }
}

document.getElementById('connectBtn').addEventListener('click', connectBLE);
</script>
</body>
</html>
