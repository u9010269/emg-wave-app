<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EMG 波形顯示</title>
  <style>
    canvas { border: 1px solid #ccc; width: 100%; height: 200px; }
    button { padding: 10px; font-size: 16px; margin: 10px 0; }
  </style>
</head>
<body>
  <h2>Web Bluetooth EMG 波形</h2>
  <button id="connect">連接藍牙</button>
  <canvas id="canvas" width="600" height="200"></canvas>

  <script>
    let characteristic;
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let data = Array(600).fill(0);  // 初始波形資料

    function drawGraph() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      ctx.moveTo(0, canvas.height - data[0]);
      for (let x = 1; x < data.length; x++) {
        ctx.lineTo(x, canvas.height - data[x]);
      }
      ctx.strokeStyle = '#0074D9';
      ctx.stroke();
    }

    function processData(value) {
      const text = new TextDecoder().decode(value);
      const match = text.match(/EMG:(\d+)/);
      if (match) {
        let val = parseInt(match[1]);
        let y = Math.min(200, Math.max(0, (val - 200))); // 映射高度
        data.push(y);
        if (data.length > 600) data.shift();
        drawGraph();
      }
    }

    document.getElementById('connect').addEventListener('click', async () => {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'MLT' }],
          optionalServices: ['ffe0']
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('ffe0');
        characteristic = await service.getCharacteristic('ffe1');

        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', (event) => {
          processData(event.target.value);
        });

        alert('藍牙連線成功！');
      } catch (err) {
        alert('連線失敗：' + err);
      }
    });
  </script>
</body>
</html>
