<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EMG å³æ™‚æ³¢å½¢åœ–</title>
<style>
    body { background-color: black; color: #0f0; text-align: center; font-family: Arial, sans-serif; }
    canvas { background-color: #111; display: block; margin: 0 auto; }
    button { font-size: 20px; padding: 10px 20px; margin: 10px; }
</style>
</head>
<body>

<h1>EMG å³æ™‚æ³¢å½¢åœ–</h1>
<button onclick="connectBluetooth()">ğŸ”— é€£æ¥ EMG è£ç½®</button>
<button onclick="manualRead()">ğŸ“¡ æ‰‹å‹•è®€å–æ•¸æ“š</button>
<canvas id="waveform" width="400" height="200"></canvas>
<p id="emgValue">EMG æ•¸å€¼: -</p>
<p id="debug">ç­‰å¾…é€£ç·š...</p>
<p id="manualResult">æœªè®€å–</p>

<script>
let canvas = document.getElementById('waveform');
let ctx = canvas.getContext('2d');
let values = new Array(canvas.width).fill(100);
let characteristic = null;

function draw() {
    ctx.fillStyle = '#111';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.strokeStyle = '#0f0';
    ctx.beginPath();
    ctx.moveTo(0, canvas.height - values[0]);

    for (let x = 1; x < values.length; x++) {
        ctx.lineTo(x, canvas.height - values[x]);
    }
    ctx.stroke();
}

function addValue(val) {
    values.push(val);
    values.shift();
    draw();
}

async function connectBluetooth() {
    try {
        const device = await navigator.bluetooth.requestDevice({
            filters: [{ services: ["ffe0"] }]  // ç¢ºä¿ UUID æ­£ç¢º
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService("ffe0");
        characteristic = await service.getCharacteristic("ffe1");

        document.getElementById("debug").innerText = "âœ… å·²é€£ç·šï¼Œé–‹å§‹æ¥æ”¶æ•¸æ“š";
        startNotifications();

    } catch (error) {
        document.getElementById("debug").innerText = "âŒ é€£ç·šå¤±æ•—ï¼š" + error;
    }
}

function startNotifications() {
    if (!characteristic) {
        document.getElementById("debug").innerText = "âš ï¸ ç‰¹å¾µå€¼æœªåˆå§‹åŒ–ï¼Œç„¡æ³•è®€å–æ•¸æ“š";
        return;
    }

    characteristic.startNotifications().then(() => {
        document.getElementById("debug").innerText = "ğŸ”µ BLE é€šçŸ¥å•Ÿå‹•æˆåŠŸï¼";

        characteristic.addEventListener("characteristicvaluechanged", (event) => {
            let emgString = new TextDecoder().decode(event.target.value.buffer);
            let emg = parseInt(emgString.trim());

            document.getElementById("emgValue").innerText = "EMG æ•¸å€¼: " + emg;
            document.getElementById("debug").innerText = "âš¡ æ”¶åˆ° EMG æ•¸æ“šï¼š" + emgString;

            let mapped = Math.min(200, Math.max(0, emg));
            addValue(mapped);
        });
    }).catch(error => {
        document.getElementById("debug").innerText = "âŒ å•Ÿå‹•é€šçŸ¥å¤±æ•—ï¼š" + error;
    });
}

// æ‰‹å‹•è®€å–æ•¸æ“šï¼ˆæ¸¬è©¦ HM-10 æ˜¯å¦èƒ½æä¾›æ•¸æ“šï¼‰
async function manualRead() {
    if (!characteristic) {
        document.getElementById("manualResult").innerText = "âŒ ç‰¹å¾µå€¼æœªåˆå§‹åŒ–ï¼Œç„¡æ³•è®€å–æ•¸æ“š";
        return;
    }

    try {
        const value = await characteristic.readValue();
        let emgString = new TextDecoder().decode(value.buffer);
        document.getElementById("manualResult").innerText = "ğŸ“¡ æ”¶åˆ°æ•¸æ“š: " + emgString;
    } catch (error) {
        document.getElementById("manualResult").innerText = "âŒ æ‰‹å‹•è®€å–å¤±æ•—ï¼š" + error;
    }
}

// åˆå§‹åŒ–ç•«é¢
setInterval(() => addValue(values[values.length - 1]), 50);

</script>

</body>
</html>
