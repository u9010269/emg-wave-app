
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>EMG å¹³å‡é¡¯ç¤ºå„ªåŒ–ç‰ˆï¼ˆUIæ’ç‰ˆæ›´æ–°ï¼‰</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    canvas { max-width: 100%; height: 250px; }
    .btn-group { margin-top: 10px; margin-bottom: 10px; }
    button {
      font-size: 1.1em; padding: 8px 16px; margin-right: 10px; margin-bottom: 6px;
      border: none; border-radius: 5px; cursor: pointer;
    }
    select, input[type="number"] {
      font-size: 1em; margin-left: 10px;
    }
    .inline-group {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }
  
.active-mode {
  background-color: #dc3545 !important;
  color: white !important;
}

</style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>EMG åŸå§‹æ³¢å½¢åœ–</h2>
  <div class="btn-group inline-group">
    <button id="toggleMp3Btn" onclick="toggleMp3()" style="background-color:#ff6600; color:white;">åˆ‡æ›MP3éŸ³æ•ˆï¼ˆç›®å‰ï¼šé—œï¼‰</button>
    <label>MP3é–€æª»å€¼ï¼š<input id="mp3Threshold" type="number" value="350" style="width: 80px;" /></label>
    <label>æ¯ç§’ç•«é¢æ›´æ–°æ¬¡æ•¸ï¼š<input type="number" id="displayRate" value="20" min="1" max="33" style="width: 60px;" /></label>
  </div>
  <div class="btn-group">
    <button onclick="connect()" style="background-color:#28a745; color:white;">é€£æ¥è—ç‰™</button>
    <button id="pauseBtn" onclick="togglePause()" style="background-color:#007BFF; color:white;">æš«åœ</button>
  </div>
  <p id="value">åŸå§‹æ•¸å€¼ï¼š--</p>
  <canvas id="emgChart"></canvas>
  <h2 id="zoomTitle">EMG æ ¡æ­£æ³¢å½¢åœ–ï¼ˆè™•ç†æ¨¡å¼ï¼‰
    <button onclick="performCalibration()" style="background-color:#ffc107; color:black; font-size: 0.9em; margin-left: 10px;">ğŸ“ æ ¡æ­£</button>
  </h2>
  
<!-- åŸæœ¬çš„ä½ç½®ä¸‹æ–¹åŠ ä¸Šé€™çµ„æŒ‰éˆ• -->
<div class="btn-group inline-group">
  <button id="mode-raw" class="mode-btn" onclick="setMode('raw')" style="background-color:#17a2b8; color:white;">åŸå§‹å€¼</button>
<button id="mode-mean" class="mode-btn active-mode" onclick="setMode('mean')" style="background-color:#17a2b8; color:white;">å¹³å‡å€¼</button>
  <button id="mode-rms" class="mode-btn" onclick="setMode('rms')" style="background-color:#17a2b8; color:white;">RMS</button>
  <button id="mode-smooth" class="mode-btn" onclick="setMode('smooth')" style="background-color:#17a2b8; color:white;">æ»‘å‹•å¹³å‡</button>
</div>

  <canvas id="zoomChart"></canvas>
  <p id="adjusted">æ ¡æ­£å¾Œæ•¸å€¼ï¼š--</p>
  <p id="mvc">å³æ™‚å¼·åº¦ï¼š-- %</p>

  <div class="btn-group">
    <label>æ ¡æ­£æ•¸å€¼å€ç‡ï¼š
      <select id="amplifyRate">
        <option value="1">100%</option>
        <option value="1.5">150%</option>
        <option value="2">200%</option>
      </select>
    </label>
  </div>

  <audio id="mp3Player" preload="auto" src="https://u9010269.github.io/emg-wave-app/350.mp3"></audio>

  <script>
    let characteristic = null;
    let isPaused = false;
    let isCalibrated = false;
    let calibrationBaseline = 0;
    let maxAdjusted = 1;
    let mode = 'mean';
    const AVG_WINDOW = 10;
    let emgBuffer = Array(AVG_WINDOW).fill(0);
    const rawData = Array(100).fill(0);
const baselineData = Array(100).fill(0);  // å›ºå®šç•« y=0 ç´…ç·š
    const zoomData = Array(100).fill(0);
const dynamicData = Array(100).fill(0);
    let mp3Enabled = false;
    let mp3Played = false;
    let mp3Player = null;
let smoothedValue = 0;

    let bufferGroup = [];
    let lastDisplayTime = Date.now();

    window.addEventListener("DOMContentLoaded", () => {
      mp3Player = document.getElementById("mp3Player");
    });

    function toggleMp3() {
      mp3Enabled = !mp3Enabled;
      const btn = document.getElementById("toggleMp3Btn");
      btn.innerText = "åˆ‡æ›MP3éŸ³æ•ˆï¼ˆç›®å‰ï¼š" + (mp3Enabled ? "é–‹" : "é—œ") + "ï¼‰";
      if (mp3Enabled && mp3Player) {
        mp3Player.play().then(() => {
          mp3Player.pause(); mp3Player.currentTime = 0;
        }).catch(e => console.warn("éŸ³è¨Šåˆå§‹åŒ–éœ€äº’å‹•"));
      }
    }

    const emgChart = new Chart(document.getElementById('emgChart'), {
      type: 'line',
      data: {
        labels: Array(100).fill(''),
        datasets: [{
          label: 'åŸå§‹ EMG',
          data: rawData,
          borderColor: 'blue',
          borderWidth: 1,
          pointRadius: 0
        }]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: { grid: { display: false } },
          y: { suggestedMin: 0, suggestedMax: 1023 }
        }
      }
    });

    const zoomChart = new Chart(document.getElementById('zoomChart'), {
      type: 'line',
      data: {
        labels: Array(100).fill(''),
        datasets: [
          {
            label: 'é¡¯ç¤ºæ¨¡å¼ç·š',
            data: dynamicData,
            borderColor: 'orange',
            borderWidth: 1,
            pointRadius: 0
          },
          {
            label: 'æ ¡æ­£å¾Œ EMG',
            data: zoomData,
            borderColor: 'green',
            borderWidth: 1,
            pointRadius: 0
          },
          {
            label: 'åŸºæº–ç·š',
            data: baselineData,
            borderColor: 'red',
            borderWidth: 1,
            pointRadius: 0
          }
        ]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: { grid: { display: false } },
          y: { min: -100, max: 200 }
        }
      }
    });

    
function getProcessedEMG(val) {
  emgBuffer.push(val); emgBuffer.shift();
  if (mode === 'raw') return val;
  if (mode === 'mean') return Math.floor(emgBuffer.reduce((a, b) => a + b, 0) / AVG_WINDOW);
  if (mode === 'rms') return Math.floor(Math.sqrt(emgBuffer.reduce((a, b) => a + b * b, 0) / AVG_WINDOW));
  if (mode === 'smooth') {
    const alpha = 0.2;
    smoothedValue = alpha * val + (1 - alpha) * smoothedValue;
    return Math.floor(smoothedValue);
  }
  return val;
}


    function updateChartData(chart, dataArray, newVal) {
      dataArray.push(newVal);
      dataArray.shift();
    }

    async function connect() {
      const device = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: 'MLT' }], optionalServices: ['ffe0'] });
      const server = await device.gatt.connect();
      const service = await server.getPrimaryService('ffe0');
      characteristic = await service.getCharacteristic('ffe1');
      readEMGLoop();
    }

    function togglePause() {
      isPaused = !isPaused;
      document.getElementById("pauseBtn").innerText = isPaused ? "æ¢å¾©" : "æš«åœ";
    }

    async function performCalibration() {
      let sum = 0, count = 0;
      alert("è«‹ä¿æŒæ”¾é¬†ï¼Œé–‹å§‹æ ¡æ­£...");
      const interval = setInterval(async () => {
        const value = await characteristic.readValue();
        const emg = parseInt(new TextDecoder().decode(value).trim());
        if (!isNaN(emg)) {
          sum += emg; count++;
          if (count >= 100) {
            calibrationBaseline = Math.floor(sum / count);
            isCalibrated = true;
            clearInterval(interval);
            alert("æ ¡æ­£å®Œæˆï¼ŒåŸºæº–å€¼ï¼š" + calibrationBaseline);
          }
        }
      }, 100);
    }

    
function setMode(newMode) {
  mode = newMode;
  document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active-mode'));
  const target = document.getElementById('mode-' + newMode);
  if (target) target.classList.add('active-mode');
}


async function readEMGLoop() {
      while (true) {
        await readEMG();
        await new Promise(r => setTimeout(r, 30));
      }
    }

    async function readEMG() {
      if (!characteristic || isPaused) return;
      const value = await characteristic.readValue();
      const emg = parseInt(new TextDecoder().decode(value).trim());
      if (isNaN(emg) || emg <= 100 || emg >= 1024) return;

      bufferGroup.push(emg);
      const now = Date.now();
      const displayRate = parseInt(document.getElementById("displayRate").value) || 5;
      const displayInterval = 1000 / displayRate;

      if (now - lastDisplayTime >= displayInterval) {
        const avgEMG = Math.floor(bufferGroup.reduce((a, b) => a + b, 0) / bufferGroup.length);
        bufferGroup = [];
        lastDisplayTime = now;

        const processed = getProcessedEMG(avgEMG);
        const adjusted = isCalibrated ? Math.max(0, processed - calibrationBaseline) : 0;
        const amplified = Math.floor(adjusted * parseFloat(document.getElementById('amplifyRate').value));

        updateChartData(emgChart, rawData, avgEMG);
        updateChartData(zoomChart, zoomData, amplified);

        if (amplified > maxAdjusted) maxAdjusted = amplified;
        const percent = Math.round((amplified / maxAdjusted) * 100);
        document.getElementById('value').innerText = 'åŸå§‹æ•¸å€¼ï¼š' + avgEMG;
        document.getElementById('adjusted').innerText = 'æ ¡æ­£å¾Œæ•¸å€¼ï¼š' + amplified;
        document.getElementById('mvc').innerText = 'å³æ™‚å¼·åº¦ï¼š' + percent + ' %';


        emgChart.update('none');
        
        
        
        let dynamicVal = 0;
        if (mode === 'raw') {
          dynamicVal = amplified;
        } else if (mode === 'mean') {
          dynamicVal = Math.floor(emgBuffer.reduce((a, b) => a + b, 0) / AVG_WINDOW);
        } else if (mode === 'rms') {
          dynamicVal = Math.floor(Math.sqrt(emgBuffer.reduce((a, b) => a + b * b, 0) / AVG_WINDOW));
        } else if (mode === 'smooth') {
          const alpha = 0.2;
          smoothedValue = alpha * avgEMG + (1 - alpha) * smoothedValue;
          dynamicVal = Math.floor(smoothedValue);
        }
        dynamicData.push(dynamicVal); dynamicData.shift();
        zoomChart.data.datasets[0].data = dynamicData;
        zoomChart.data.datasets[1].data = zoomData;
        zoomChart.data.datasets[2].data = baselineData;
        zoomChart.update('none');
              }

      const threshold = parseInt(document.getElementById("mp3Threshold").value);
      if (mp3Enabled && mp3Player) {
        if (emg > threshold && !mp3Played) {
          mp3Player.currentTime = 0;
          mp3Player.play().catch(e => console.warn("MP3æ’­æ”¾å¤±æ•—ï¼š", e));
          mp3Played = true;
        } else if (emg <= threshold) {
          mp3Played = false;
        }
      }
    }
  </script>
</body>
</html>
